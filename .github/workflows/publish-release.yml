name: Publish Lume Release

on:
  push:
    tags:
      - 'v*.*.*'  # Now supports semantic versioning (v1.0.0, v2.1.5, etc.)

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout code
      - uses: actions/checkout@v3
        
      # 2. Setup Flutter
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.x'  # Updated to more recent Flutter version
        
      # 3. Install dependencies
      - name: Install dependencies
        run: flutter pub get
          
      # 4. Build APK
      - name: Build Release APK
        run: |
          flutter build apk --release --target-platform android-arm64
          mkdir -p releases/versions/${{ github.ref_name }}
          cp build/app/outputs/flutter-apk/app-release.apk releases/versions/${{ github.ref_name }}/lume.apk
          
      # 5. Create detailed release info
      - name: Create release info
        run: |
          TAG_VERSION=$(echo '${{ github.ref_name }}' | sed 's/v//')
          CURRENT_DATE=$(date +'%Y-%m-%d')
          
          echo '{
            "version": "'$TAG_VERSION'",
            "buildNumber": "'$GITHUB_RUN_NUMBER'",
            "title": "Lume $TAG_VERSION",
            "description": "Esta é versão inicial do Lume.",
            "downloadUrl": "https://github.com/Drew005/Lume/releases/download/${{ github.ref_name }}/lume.apk",
            "isForced": false,
            "releaseDate": "'$CURRENT_DATE'",
            "features": [
              "Versão inicial do Lume",
              "Interface principal completa",
              "Funcionalidades básicas implementadas"
            ],
            "improvements": [
              "Performance inicial otimizada",
              "Estrutura de código organizada"
            ],
            "bugFixes": [
              "Correções de bugs críticos encontrados durante desenvolvimento"
            ]
          }' > releases/versions/${{ github.ref_name }}/info.json
          
      # 6. Update latest version pointer
      - name: Update latest version pointer
        run: |
          echo '{
            "version": "'$(echo '${{ github.ref_name }}' | sed 's/v//')'",
            "url": "https://raw.githubusercontent.com/Drew005/Lume/main/releases/versions/${{ github.ref_name }}/info.json"
          }' > releases/latest.json
          
      # 7. Create GitHub Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            releases/versions/${{ github.ref_name }}/lume.apk
            releases/versions/${{ github.ref_name }}/info.json
          tag_name: ${{ github.ref_name }}
          body: |
            ## Novidades na versão ${{ github.ref_name }}
            
            ### Novos Recursos
            - Novo design da interface
            - Suporte a temas escuros
            - Nova funcionalidade X
            
            ### Melhorias
            - Melhor desempenho na navegação
            - Otimização de uso de memória
            
            ### Correções
            - Corrigido crash ao abrir configurações
            - Resolvido problema de sincronização